
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-12">
                    <table class="table">
                        <tr>
                            <td><strong>Particulars</strong></td>
                            <td>@Model.Particulars</td>
                        </tr>
                        <tr>
                            <td><strong>Payee</strong></td>
                            <td>@Model.PAYEE</td>
                        </tr>
                        <tr>
                            <td><strong>Address</strong></td>
                            <td>@Model.Adress</td>
                        </tr>
                        <tr>
                            <td><strong>Fund Source</strong></td>
                            <td>@Model.FundSource</td>
                        </tr>
                        @if (Model.PR != null)
                        {
                            <tr>
                                <td><strong>PR #</strong></td>
                                <td>@Model.PR</td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div id="table_uacs" style="width: 100%; height: 200px; overflow: hidden;" data-originalstyle="width: 90%; height: 200px; overflow: hidden"  data-save="@Url.Action("SaveOrsObligation","ORS")" data-get_fund_source_uacs="@Url.Action("GetFundSourceUACS","ORS",new { ID = ViewBag.ors_obligation })" data-get="@Url.Action("GetORSUacs","ORS", new { ID = ViewBag.ors_obligation })" data-ors_obligation="@ViewBag.ors_obligation" data-delete="@Url.Action("DeleteUacs","ORS")"></div>
                </div>
            </div>
            <div class="row">
                <table class="table">
                    <tr>
                        <td width="1%"><p style="font-size:1.2em;margin-top:5px;">Total Amount</p></td>
                        <td width="1%"><p style="font-size:1.2em;margin-top:5px;">:</p></td>
                        <td width="20%"><p style="font-size:1.2em;margin-top:5px;" id="uacs_total"></p></td>
                    </tr>
                    <tr>
                        <td width="1%"><p style="font-size:1.2em;margin-bottom:0px;">Dibursements</p></td>
                        <td width="1%"><p style="font-size:1.2em;margin-bottom:0px;">:</p></td>
                        <td width="20%"><p style="font-size:1.2em;margin-bottom:0px;" id="uacs_disbursment" ></p></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>



<script>
    (function () {
        var fundsource_uacs = [];
        var fundsource_uacs_url = $("#table_uacs").data('get_fund_source_uacs');
        var container_uacs = document.getElementById("table_uacs");
        var table_uacs;
        var valid = true;
        
        table_uacs = new Handsontable(container_uacs, {
            startRows: 50,
            startCols: 7,
            rowHeaders: true,
            colWidths: [1, 350, 200, 200,200,200,200],
            stretchH: 'all',
            colHeaders: true,
            filters: true,
            contextMenu: ['row_above', 'row_below', 'remove_row', 'copy'],
            fillHandle: {
                autoInsertRow: false,
            },
            viewportColumnRenderingOffset: 20,
            colHeaders: ['ID', 'Expense Code','Amount','Disbursement','Net Amt.','Tax Amt.','Others'],
            columns: [
                {}, { type: 'autocomplete', source: fundsource_uacs, strick: true, allowInvalid: false }, {}, {}, {}, {}, {}
            ],
            cells: function (r, c, prop) {
                var cellProperties = {};
                if (c === 0 || c === 3  @(User.IsInRole("Cashier") ? " || c === 0 || c === 1 || c === 2" : "") ) cellProperties.readOnly = true;
                return cellProperties;
            },

            beforeRemoveRow: function (index, column) {
                if (confirm("Are you sure you want to delete this item") == true) {
                    var items = this.getData();
                    var row_item = items[index];
                    var url = $("#table_uacs").data('delete');

                    var data = {
                        "ID": row_item[0]
                    };

                    $.post(url, data, function (resdata) {
                    });
                    return true;
                } else {
                    return false;
                }
            },
            afterValidate: function (isValid, value, row, prop, source) {
                if (!isValid) {
                    valid = false;
                    Lobibox.alert("warning", //AVAILABLE TYPES: "error", "info", "success", "warning"
                    {
                        msg: "There was an invalid data.",
                        title: "ORS UACS"
                    });
                } else { valid = true; }
            },
        });
        $(document).ready(function () {
            var url = $("#table_uacs").data('get');
            $.get(url, function (resdata) {
                if (resdata.length > 0) {
                    var tabledata = [];
                    var total;
                    var uacs_total = 0;
                    var uacs_disbursment = 0;
                    for (var i = 0; i < resdata.length; i++) {
                        tabledata[i] = new Array(resdata[i]['ID'], resdata[i]['ExpenseTitle'], numberWithCommas(resdata[i]['Amount']), numberWithCommas(resdata[i]['Disbursement']), numberWithCommas(resdata[i]['NetAmount']), numberWithCommas(resdata[i]['TaxAmount']), numberWithCommas(resdata[i]['Others']));
                        uacs_total += resdata[i]['Amount'];
                        uacs_disbursment += resdata[i]['NetAmount'] + resdata[i]['TaxAmount'] + resdata[i]['Others'];
                    }
                    table_uacs.loadData(tabledata);
                    uacs_total = uacs_total > 0 ? numberWithCommas(uacs_total) : "0.00";
                    uacs_disbursment = uacs_disbursment > 0 ? numberWithCommas(uacs_disbursment) : "0.00";
                    $("#uacs_total").text(uacs_total);
                    $("#uacs_disbursment").text(uacs_disbursment);
                }
            });

            $.get(fundsource_uacs_url, function (expense_res) {
                if (expense_res.length > 0) {
                    for (var i = 0; i < expense_res.length; i++) {
                        fundsource_uacs[i] = expense_res[i]["Code"];
                    }
                }
            });
        });


        $("#submit_ors_save").click(function () {
            var ors_obligation = $("#table_uacs").data('ors_obligation');

            var tabledata = table_uacs.getData();
            if (tabledata.length > 0) {
                var expense = [];
                for (var i = 0; i < tabledata.length; i++) {
                    expense[i] = {
                        "ID": tabledata[i][0],
                        "expense_title": tabledata[i][1],
                        "amount": tabledata[i][2],
                        "NetAmount": tabledata[i][4],
                        "TaxAmount": tabledata[i][5],
                        "Others" : tabledata[i][6]
                    };
                }

                var data = {
                    ID: ors_obligation,
                    data: JSON.stringify(expense)
                };
                var url = $("#table_uacs").data('save');
                $.post(url, data, function (resdata) {
                    if (resdata.length > 0) {
                        var tabledata = [];
                        var total;
                        var uacs_total = 0;
                        var uacs_disbursment = 0;
                        for (var i = 0; i < resdata.length; i++) {
                            tabledata[i] = new Array(resdata[i]['ID'], resdata[i]['ExpenseTitle'], numberWithCommas(resdata[i]['Amount']), numberWithCommas(resdata[i]['Disbursement']), numberWithCommas(resdata[i]['NetAmount']), numberWithCommas(resdata[i]['TaxAmount']), numberWithCommas(resdata[i]['Others']));
                            uacs_total += resdata[i]['Amount'];
                            uacs_disbursment += resdata[i]['NetAmount'] + resdata[i]['TaxAmount'] + resdata[i]['Others'];
                        }
                        table_uacs.loadData(tabledata);
                        uacs_total = uacs_total > 0 ? numberWithCommas(uacs_total) : "0.00";
                        uacs_disbursment = uacs_disbursment > 0 ? numberWithCommas(uacs_disbursment) : "0.00";
                        $("#uacs_total").text(uacs_total);
                        $("#uacs_disbursment").text(uacs_disbursment);
                    }
                });
            }
        });
    })();
    
</script>

